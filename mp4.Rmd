---
title: "mp4"
authors: 
date: May 10, 2018
output: 
  html_document:
    df_print: paged
    code_folding: hide
    theme: "sandstone"
---
**add figure captions

We used this github repository to work on our project [^1].


```{r, message = FALSE, warning = FALSE}
library(mdsr)
library(RMySQL)
library(tidyverse)
db <- dbConnect_scidb(dbname = "imdb")
```

```{r, message = FALSE, warning = FALSE}
# Get movies for specified year
moviesdb <- function(s) {
            st <- "SELECT mi1.movie_id, 
                  mi1.info AS gross, 
                  mi2.info, 
                  t.title,
                  t.production_year
            FROM title AS t
            JOIN movie_info AS mi1 ON
                mi1.movie_id = t.id
            JOIN movie_info AS mi2 ON 
                mi2.movie_id = mi1.movie_id
            WHERE mi1.info_type_id = 107
                    AND mi2.info_type_id = 8
                    AND mi2.info = 'USA'
                AND t.production_year = years"; 
            q <- sub("years", s, st)
            return(dbGetQuery(db, q))
}

# Extract gross from specified database
grossdb <- function(dbs) {
  dbs %>%
  filter(grepl("\\(USA\\)|worldwide|Worldwide", gross)) %>%
  mutate(gross_string = str_extract(gross, "^\\$[0-9]+,[0-9]{3},[0-9]{3}"),
         gross = parse_number(gross_string)) %>%
  group_by(movie_id, title, production_year) %>%
  summarise(sum_gross = sum(gross)) %>%
  arrange(desc(sum_gross))
}

# Get total director of specified year
alldirdb <- function(s){
            st <- "SELECT movie_id,
                          person_id,
                          gender,
                          production_year,
                          t.title,
                          COUNT(DISTINCT(person_id)) AS totaldirectors
                    FROM imdb.cast_info AS ci 
                    JOIN name AS n ON n.id = ci.person_id
                    JOIN title AS t ON t.id = ci.movie_id
                    WHERE role_id = 8
                    AND production_year = years;"
            q <- sub("years", s, st)
            return(dbGetQuery(db, q))
}

# Get total female director of specified year
femdirdb <- function(s){
        st <- "SELECT movie_id,
                      person_id,
                      gender, 
                      t.title,
                      production_year,
                      COUNT(Distinct person_id) AS femaledirectors 
               FROM imdb.cast_info AS ci 
               JOIN name AS n ON n.id = ci.person_id
               JOIN title AS t ON t.id = ci.movie_id
               WHERE role_id = 8
                  AND production_year = years
                  AND gender = 'f';"
        q <- sub("years", s, st)
        return(dbGetQuery(db, q))
}
```

```{r, message = FALSE, warning = FALSE}
movies_67 <- moviesdb(1967)
gross_67 <- grossdb(movies_67)
alldir_67 <- alldirdb(1967)
femdir_67 <- femdirdb(1967)
prop67 <- femdir_67 %>%
           mutate(prop = femaledirectors/alldir_67$totaldirectors)
```

```{r, message = FALSE, warning = FALSE}
movies_77 <- moviesdb(1977)
gross_77 <- grossdb(movies_77)
alldir_77 <- alldirdb(1977)
femdir_77 <- femdirdb(1977)
prop77 <- femdir_77 %>%
           mutate(prop = femaledirectors/alldir_77$totaldirectors)
```

```{r, message = FALSE, warning = FALSE}
movies_87 <- moviesdb(1987)
gross_87 <- grossdb(movies_87)
alldir_87 <- alldirdb(1987)
femdir_87 <- femdirdb(1987)
prop87 <- femdir_87 %>%
           mutate(prop = femaledirectors/alldir_87$totaldirectors)
```

```{r}
movies_97 <- moviesdb(1997)
gross_97 <- grossdb(movies_97)
alldir_97 <- alldirdb(1997)
femdir_97 <- femdirdb(1997)
prop97 <- femdir_97 %>%
           mutate(prop = femaledirectors/alldir_97$totaldirectors)
```

```{r}
movies_07 <- moviesdb(2007)
gross_07 <- grossdb(movies_07)
alldir_07 <- alldirdb(2007)
femdir_07 <- femdirdb(2007)
prop07 <- femdir_07 %>%
           mutate(prop = femaledirectors/alldir_07$totaldirectors)
```

```{r}
movies_17 <- moviesdb(2017)
gross_17 <- grossdb(movies_17)
alldir_17 <- alldirdb(2017)
femdir_17 <- femdirdb(2017)
prop17 <- femdir_17 %>%
           mutate(prop = femaledirectors/alldir_17$totaldirectors)
```

```{r}
allyears<- merge(prop67, prop77, all=TRUE)
allyears1<-merge(allyears, prop87, all = TRUE)
allyears2<-merge(allyears1, prop97, all = TRUE)
allyears3<-merge(allyears2, prop07, all = TRUE)
allyearstotal<-merge(allyears3, prop17, all = TRUE)

allyearsfinal <- allyearstotal %>%
  arrange(production_year) %>%
  mutate(prop_male = 1)
```


```{r, message = FALSE, warning = FALSE}
#find top movie directed by women for each of our selected years for annotations
# Get movies for specified year
library(dplyr)
# Get movies for specified year
moviesdb <- function(s) {
            st <- "SELECT mi1.movie_id, 
                  mi1.info AS gross, 
                  mi2.info, 
                  t.title,  
                  t.production_year
            FROM title AS t
            JOIN movie_info AS mi1 ON
                mi1.movie_id = t.id
            JOIN movie_info AS mi2 ON 
                mi2.movie_id = mi1.movie_id
            JOIN imdb.cast_info AS ci ON ci.movie_id = t.id
            JOIN name as n ON n.id = ci.person_id
            WHERE mi1.info_type_id = 107
                    AND mi2.info_type_id = 8
                    AND mi2.info = 'USA'
                    AND gender = 'f'
                    AND role_id = 8
                AND t.production_year = years"; 
            q <- sub("years", s, st)
            return(dbGetQuery(db, q))
}

# Extract gross from specified database in order to find top films by women
grossdb <- function(dbs) {
  dbs %>%
  filter(grepl("\\(USA\\)|worldwide|Worldwide", gross)) %>%
  mutate(gross_string = str_extract(gross, "^\\$[0-9]+,[0-9]{3},[0-9]{3}"),
         gross = parse_number(gross_string)) %>%
  group_by(movie_id, title, production_year) %>%
  summarise(sum_gross = sum(gross)) %>%
  arrange(desc(sum_gross))
}
```

```{r, message = FALSE, warning = FALSE}
#get titles of top movies of 1967
mov67 <- moviesdb(1967)
gross67 <- grossdb(mov67)
gross67
#top movie directed by women in 1967: NONE

#get titles of top movies 1977
mov77 <- moviesdb(1977)
gross77 <- grossdb(mov77)
gross77
#top movie directed by women in 1977: NONE
#1978 = Moment by Moment, #1980 = It's My Turn

#get titles for top movies of 1987
mov87 <- moviesdb(1987)
gross87 <- grossdb(mov87)
gross87
#top movie directed by women in 1987: Ishtar, Back to the Beach, Maid to Order

# get titles for top movies of 1997
mov97 <- moviesdb(1997)
gross97 <- grossdb(mov97)
gross97
#top movie directed by women in 1997: The Peacemaker, Private Pars, Out to Sea

#get titles for top movies of 2007
mov07 <- moviesdb(2007)
gross07 <- grossdb(mov07)
gross07
#top movie directed by women in 2007: August Rush, The Nanny Diaries, La misma luna

#get title for top movies of 2017
mov17 <- moviesdb(2017)
gross17 <- grossdb(mov17)
gross17
#top movie directed by women 2017: Wonder Woman, Rough Night, The Beguiled
```


```{r}
#plot proportion of female vs male directors 
ggplot(allyearsfinal, aes(x = production_year, y = prop, fill = gender)) + 

geom_area(aes(x = production_year, y =  prop_male, fill = 'm')) +
  
geom_area(aes(x = production_year, y = prop, fill = 'f'))  +
  
geom_line(col = '#000000', size = 0.5)  + 
  
scale_x_continuous(limits = c(1967, 2017), breaks = seq(1967, 2017, 10), labels = c("1967", "1977", "1987", "1997", "2007", "2017"), expand = c(0,0)) + scale_fill_manual(values = c('salmon1', 'royalblue')) + 
  
scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1), labels = c("0", "0.5", "1"), expand = c(0,0)) +
  
labs (title = "Gender of Movie Directors Over the Past 50 Years", x = "Production Year", y = "Proportion of Directors", fill = "Gender") +
  
  annotate("text", x = 2012.8, y = 0.19, label = 
"Wonder Woman", size = 3, family = "sans", color = "white") +
  annotate("text", x = 2006, y = 0.14, label = "August Rush", size = 3, family = "sans", color = "white") +
  annotate("text", x = 1997, y = 0.12, label = "The Peacemaker", size = 3, family = "sans", color = "white") +
  annotate("text", x = 1987, y = 0.11, label = "Ishtar", size = 3, family = "sans", color = "white") +
  annotate("text", x = 1978, y = 0.1, label = "Moment By Moment", size = 3, family = "sans", color = "white") +
  
  geom_point(x = 1987, y = 0.054, size = 3, shape = 21, color = "black", fill = "white") +  geom_point(x = 1978, y = 0.04, size = 3, shape = 21, color = "black", fill = "white") +  geom_point(x = 1997, y = 0.066, size = 3, shape = 21, color = "black", fill = "white") +  geom_point(x = 2007, y = 0.07, size = 3, shape = 21, color = "black", fill = "white") +  geom_point(x = 2017, y = 0.09, size = 3, shape = 21, color = "black", fill = "white")


```

[^1]: [Link to github repository](https://github.com/rmoskowitz/mp4)
