---
title: "mp4"
output: html_document
---

```{r}
library(mdsr)
library(RMySQL)
library(tidyverse)
db <- dbConnect_scidb(dbname = "imdb")
```

```{r}
# Get movies for specified year
moviesdb <- function(s) {
            st <- "SELECT mi1.movie_id, 
                  mi1.info AS gross, 
                  mi2.info, 
                  t.title,
                  t.production_year
            FROM title AS t
            JOIN movie_info AS mi1 ON
                mi1.movie_id = t.id
            JOIN movie_info AS mi2 ON 
                mi2.movie_id = mi1.movie_id
            WHERE mi1.info_type_id = 107
                    AND mi2.info_type_id = 8
                    AND mi2.info = 'USA'
                AND t.production_year = years"; 
            q <- sub("years", s, st)
            return(dbGetQuery(db, q))
}

# Extract gross from specified database
grossdb <- function(dbs) {
  dbs %>%
  filter(grepl("\\(USA\\)|worldwide|Worldwide", gross)) %>%
  mutate(gross_string = str_extract(gross, "^\\$[0-9]+,[0-9]{3},[0-9]{3}"),
         gross = parse_number(gross_string)) %>%
  group_by(movie_id, title, production_year) %>%
  summarise(sum_gross = sum(gross)) %>%
  arrange(desc(sum_gross))
}

# Get total director of specified year
alldirdb <- function(s){
            st <- "SELECT movie_id,
                          person_id,
                          gender,
                          production_year,
                          t.title,
                          COUNT(DISTINCT(person_id)) AS totaldirectors
                    FROM imdb.cast_info AS ci 
                    JOIN name AS n ON n.id = ci.person_id
                    JOIN title AS t ON t.id = ci.movie_id
                    WHERE role_id = 8
                    AND production_year = years;"
            q <- sub("years", s, st)
            return(dbGetQuery(db, q))
}

# Get total female director of specified year
femdirdb <- function(s){
        st <- "SELECT movie_id,
                      person_id,
                      gender, 
                      t.title,
                      production_year,
                      COUNT(Distinct person_id) AS femaledirectors 
               FROM imdb.cast_info AS ci 
               JOIN name AS n ON n.id = ci.person_id
               JOIN title AS t ON t.id = ci.movie_id
               WHERE role_id = 8
                  AND production_year = years
                  AND gender = 'f';"
        q <- sub("years", s, st)
        return(dbGetQuery(db, q))
}
```

```{r}
movies_67 <- moviesdb(1967)
gross_67 <- grossdb(movies_67)
alldir_67 <- alldirdb(1967)
femdir_67 <- femdirdb(1967)
prop67 <- femdir_67 %>%
           mutate(prop = femaledirectors/alldir_67$totaldirectors)
```

```{r}
movies_77 <- moviesdb(1977)
gross_77 <- grossdb(movies_77)
alldir_77 <- alldirdb(1977)
femdir_77 <- femdirdb(1977)
prop77 <- femdir_77 %>%
           mutate(prop = femaledirectors/alldir_77$totaldirectors)
```

```{r}
movies_87 <- moviesdb(1987)
gross_87 <- grossdb(movies_87)
alldir_87 <- alldirdb(1987)
femdir_87 <- femdirdb(1987)
prop87 <- femdir_87 %>%
           mutate(prop = femaledirectors/alldir_87$totaldirectors)
```

```{r}
movies_97 <- moviesdb(1997)
gross_97 <- grossdb(movies_97)
alldir_97 <- alldirdb(1997)
femdir_97 <- femdirdb(1997)
prop97 <- femdir_97 %>%
           mutate(prop = femaledirectors/alldir_97$totaldirectors)
```

```{r}
movies_07 <- moviesdb(2007)
gross_07 <- grossdb(movies_07)
alldir_07 <- alldirdb(2007)
femdir_07 <- femdirdb(2007)
prop07 <- femdir_07 %>%
           mutate(prop = femaledirectors/alldir_07$totaldirectors)
```

```{r}
movies_17 <- moviesdb(2017)
gross_17 <- grossdb(movies_17)
alldir_17 <- alldirdb(2017)
femdir_17 <- femdirdb(2017)
prop17 <- femdir_17 %>%
           mutate(prop = femaledirectors/alldir_17$totaldirectors)
```

```{r}
allyears<- merge(prop67, prop77, all=TRUE)
allyears1<-merge(allyears, prop87, all = TRUE)
allyears2<-merge(allyears1, prop97, all = TRUE)
allyears3<-merge(allyears2, prop07, all = TRUE)
allyearstotal<-merge(allyears3, prop17, all = TRUE)

allyearsfinal <- allyearstotal %>%
  arrange(production_year) %>%
  mutate(prop_male = 1)
```


```{r}
#find top movie directed by women for each of our selected years for annotations
# Get movies for specified year
movie <- function(s) {
            st <- "SELECT mi1.movie_id, 
                  mi1.info AS gross, 
                  mi2.info, 
                  t.title,
                  t.production_year
            FROM title AS t
            JOIN movie_info AS mi1 ON
                mi1.movie_id = t.id
            JOIN movie_info AS mi2 ON 
                mi2.movie_id = mi1.movie_id
            JOIN name AS n ON n.id = t.id
            WHERE mi1.info_type_id = 107
                    AND mi2.info_type_id = 8
                    AND mi2.info = 'USA'
                AND t.production_year = years
                  AND gender = 'f'"; 
            q <- sub("years", s, st)
            return(dbGetQuery(db, q))
}

# Extract gross from specified database
gross <- function(dbs) {
  dbs %>%
  filter(grepl("\\(USA\\)|worldwide|Worldwide", gross)) %>%
  mutate(gross_string = str_extract(gross, "^\\$[0-9]+,[0-9]{3},[0-9]{3}"),
         gross = parse_number(gross_string)) %>%
  group_by(movie_id, title, production_year) %>%
  summarise(sum_gross = sum(gross)) %>%
  arrange(desc(sum_gross))
}

```{r}
movie <- movie(1967)
gross <- gross(movie67)
gross67 
#top movie directed by women in 1967 = Guess Who's Coming to Dinner, Bonnie and Clyde, Casino Royale

#top movie directed by women in 1977 = 

#top movie directed by women in 1987 = 

#top movie directed by women in 1997 =

#top movie directed by women in 20007



```





```

# Get total female director of specified year
fem <- function(s){
        st <- "SELECT movie_id,
                      person_id,
                      gender, 
                      t.title,
                      production_year
               FROM imdb.cast_info AS ci 
               JOIN name AS n ON n.id = ci.person_id
               JOIN title AS t ON t.id = ci.movie_id
               WHERE role_id = 8
                  AND production_year = years
                  AND gender = 'f';"
        q <- sub("years", s, st)
        return(dbGetQuery(db, q))
        
}


movie67 <- movie(1967)
gross67 <- gross(movie67)
alldir67 <- alldir(1967)
fem67 <- fem(1967)
prop67 <- fem67

prop67
```

```{r}
ggplot(allyearsfinal, aes(x = production_year, y = prop, fill = gender)) + 

geom_area(aes(x = production_year, y =  prop_male, fill = 'm')) +
  
geom_area(aes(x = production_year, y = prop, fill = 'f'))  +
  
geom_line(col = '#000000', size = 0.5)  + 
  
scale_x_continuous(limits = c(1967, 2017), breaks = seq(1967, 2017, 10), labels = c("1967", "1977", "1987", "1997", "2007", "2017"), expand = c(0,0)) + scale_fill_manual(values = c('slateblue3', 'grey83')) + 
  
scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1), labels = c("0", "0.5", "1"), expand = c(0,0)) +
  
labs (title = "Gender of Movie Directors & Events in Feminism Over the Past 50 Years", x = "Production Year", y = "Proportion of Directors", fill = "Gender") +
  
annotate("text", x = 1973, y = 0.2, label = "Roe v. Wade", size = 3, family = "sans", color = "black") 
```

